
import useBaseUrl from '@docusaurus/useBaseUrl';

* 了解如何在 Windows 环境下监控服务器资源是维护其性能和可靠性的关键部分。关于如何在Windows系统中监控服务器资源的更多信息，指导如何使用 Windows内置的工具来监控服务器资源占用，可查看在Windows中监控服务器资源部分的内容。

* 对于在系统资源正常的情况下出现问题的情况，在日常使用中，还可以查看我们的日志来帮助分析和定位问题。

# 在Windows中监控服务器资源

## 使用任务管理器

* 任务管理器是最基本的监控工具，它可以让迅速查看CPU、内存、磁盘和网络的即时使用情况。

1. **启动任务管理器**：
   * 右键点击任务栏然后选择“任务管理器”，或者使用快捷键 `Ctrl + Shift + Esc`。

2. **查看性能**：
   * 切换到“性能”标签，可以看到CPU、内存、磁盘和网络的实时使用图表。
   * 点击任意一个图表，将在右边显示更详细的信息，包括使用率、速率、响应时间和硬件的基本信息。

     <img alt=" " src={useBaseUrl('docimg/运维建议4302.png')} />

3. **查看进程**：
   * 在“进程”标签中，可以查看所有运行中的进程及其对CPU、内存、磁盘和网络的具体占用。
   * 可以通过点击各列的标题来对列表进行排序。

     <img alt=" " src={useBaseUrl('docimg/运维建议4301.png')} />

## 使用资源监视器

* 资源监视器提供了比任务管理器更详细的信息，它可以分析CPU、内存、磁盘和网络这四大资源。

1. **打开资源监视器**：
   * 打开任务管理器，切换到“性能”标签，然后点击左下角的“资源监视器”，或者直接在开始菜单中搜索“资源监视器”。

     <img alt=" " src={useBaseUrl('docimg/运维建议4303.png')} />

2. **资源监视器界面说明**：
   * **概览**标签展示全部四大资源的汇总信息。
   * **CPU**标签显示所有关于CPU的详细信息，包括进程、服务、关联的句柄和模块。
   * **内存**标签详细列出内存的使用情况，可以看到哪个进程占用了多少物理内存、交换文件等。
   * **磁盘**标签显示当前磁盘活动，包括系统对各个盘的读写速率和响应时间。
   * **网络**标签提供网络活动的详细视图，展示了哪些进程正在使用网络，以及他们的发送和接收情况。

     <img alt=" " src={useBaseUrl('docimg/运维建议4305.png')} />

## 使用性能监视器

* 性能监视器是一个高级工具，专门用于收集服务器的性能数据。

1. **打开性能监视器**：
   * 在开始菜单中搜索“性能监视器”，或者通过“运行”对话框（Win + R）输入 `perfmon.msc`。

     <img alt=" " src={useBaseUrl('docimg/运维建议4306.png')} />

2. **添加监视器**：
   * 在性能监视器中，可以添加计数器来监视系统中几乎任何能想到的性能指标。
   * 点击监视器页面的“添加”按钮（绿色十字图标），选择感兴趣的计数器。例如，可以选择“处理器时间”，这表示CPU花费在非闲置线程上的时间百分比。

3. **设置数据收集集**：
   * 创建一个“数据收集集”，这样就可以定义一系列的监视器计数器，并且将数据收集设置成自定的时间间隔自动运行。
   * 还可以选择将这些数据保存到日志文件中，方便后续进行分析和审查。

4. **使用性能监视器日志**：
   * 性能监视器可以保存长时间运行的日志文件，可以用它们来生成报告或者查找历史性能问题的迹象。

     <img alt=" " src={useBaseUrl('docimg/运维建议4304.png')} />

---

* 总的来说，服务器资源监控包括定期检查系统健康、合理配置资源、及时发现问题并做出调整。同时，也可以无论是使用内置工具还是第三方解决方案，目标都是保持的服务器高效稳定地运行。

## 优化建议

* cpu如果是由于IIS占比过高的，可将该网站的应用程序池-高级设置-超过90%cpu就自动重启。

  <img alt=" " src={useBaseUrl('docimg/运维建议4308.png')} />

---

* 内存一般是由于数据库占比过高。SQL Server可按照下图设置最大内存数，在右键中点击属性，打开服务器属性，点击内存。

  <img alt=" " src={useBaseUrl('docimg/运维建议4309.png')} />

---

* 设置PostgreSQL 12 及以上版本的最大内存数按照以下步骤进行操作：

1. 找到并打开 PostgreSQL 的数据目录。默认情况下，PostgreSQL 的数据目录位于`C:\Program Files\PostgreSQL\<version>\data`。

2. 在数据目录中，找到并备份 postgresql.conf 文件，以防修改出错。

3. 使用文本编辑器打开 postgresql.conf 文件。

4. 在文件中搜索 shared_buffers 参数。这个参数指定了 PostgreSQL 使用的共享内存量。

5. 根据系统的可用内存情况，适当调整 shared_buffers 的值。一般建议将 shared_buffers 的大小设置为可用内存的25%到30%。例如，如果服务器有8GB的内存，可以将shared_buffers设置为2GB到2.4GB。确保不要设置过大以免影响其他进程运行。

6. 也可以选择性地修改其他与内存相关的参数，如 work_mem、maintenance_work_mem 等。这些参数决定了 PostgreSQL 在不同操作中使用的内存量。根据服务器的实际配置和需求，适当调整这些参数可以提高性能。

7. 保存并关闭 postgresql.conf 文件。

8. 打开命令提示符，并进入 PostgreSQL 的安装目录。

9. 重启 PostgreSQL 服务，以应用修改的配置。可以使用以下命令来重启 PostgreSQL：

`pg_ctl.exe restart -D "C:\Program Files\PostgreSQL\<version>\data"`

---

* 对于 MongoDB 4.0 及以上的版本，可以直接通过设置 `storage.wiredTiger.engineConfig.cacheSizeGB` 参数来指定MongoDB的最大缓存大小。

* 在 Windows 系统上，按照以下步骤来设置 MongoDB 的缓存大小：

1. 打开 MongoDB 的配置文件 `mongod.cfg`。默认情况下，该文件位于 MongoDB 的安装目录或数据存储目录下。

2. 使用文本编辑器打开 `mongod.cfg` 文件。

3. 在文件中找到 `storage` 部分，通常以 `storage:` 开头。在该部分寻找 `engine` 参数，确保其值为 "wiredTiger"，因为缓存大小设置仅适用于WiredTiger存储引擎。

4. 在 `engineConfig` 子段中，通过添加或修改 `cacheSizeGB` 参数来指定 MongoDB 的最大缓存大小。例如，设置为`cacheSizeGB: 5`表示使用5GB的内存作为缓存大小。

   ```yaml
   storage:
     engine: wiredTiger
     engineConfig:
       cacheSizeGB: 4

5. 保存并关闭 mongod.cfg 文件。

6. 重启MongoDB。

* 请注意，确保设置的缓存大小不会超过可用的系统内存，并根据服务器的实际配置和需求进行适当的调整。

---

当需要了解计算机系统中发生的各种事件和错误时，Windows系统的事件查看器是一个非常有用的工具。它可以帮助追踪系统的运行状况，诊断问题以及监视安全审计日志。

<img alt=" " src={useBaseUrl('docimg/运维建议43010.png')} />

* 使用事件查看器

1. **打开事件查看器**

   - 在Windows 10任务栏的搜索框中输入"事件查看器"。
   - 从搜索结果中选择"事件查看器"并点击打开。

2. **浏览事件日志**

   - 事件查看器主界面分为"概要"和"查看器"两个部分。
   - "概要"部分提供了系统概览和快捷链接，比如系统日志、应用程序日志等。
   - "查看器"部分列出了不同类型的日志，包括Windows日志、应用和服务日志以及自定义视图。

3. **查看事件详细信息**

   - 在左侧的"查看器"部分选择一个日志类型，比如"Windows 日志"->"应用程序"日志。
   - 在右侧的列表中，将看到已记录的事件。
   - 点击事件以查看详细信息，包括事件的级别、描述和发生的时间。
   - 可以通过上方的"详细信息"面板查看更多关于事件的详细内容。

4. **筛选和搜索事件**

   - 使用顶部的工具栏可以对事件进行筛选和搜索。
   - 在工具栏上选择"筛选当前日志"，可以创建筛选条件来过滤特定类型的事件。
   - 在搜索框中输入关键字，事件查看器将会显示与关键字相关的事件。

5. **导出事件日志**

   - 如果需要保存事件日志或与其他人分享，可以将事件日志导出为文件。
   - 选择要导出的日志，并点击工具栏上的"保存所有事件"或"保存选定的事件"按钮。
   - 选择一个保存位置和文件名，然后点击"保存"。

6. **创建警报和任务**

   - 除了查看事件，还可以使用事件查看器创建警报和任务。
   - 在事件发生时触发警报可以帮助及时响应问题。
   - 在事件上点击右键，选择"操作"，然后选择"将此事件发送到任务"或"附加任务于事件"。

7. **了解事件代码和ID**

   - 每个事件都有一个事件ID和来源，这些信息有助于诊断问题或进行进一步的研究。
   - 事件ID可以提供关于事件类型的重要信息，而事件来源可以告诉事件来自哪个应用程序或服务。

     <img alt=" " src={useBaseUrl('docimg/运维建议43011.png')} />

# 查看Imgenius系统日志

* 默认位置为`C:\imLog`，可查看对应7大服务（常规使用情况下为5个）的日志、SDC、SMC、EOC、消息系统的日志。

  <img alt=" " src={useBaseUrl('docimg/运维建议4307.png')} />

* imSyncManagement对应通知服务，imDataManagement对应数据服务，imProcessManagement对应流程服务，imSearchManagement对应搜索服务，
imTaskManagement对应作业服务，imExternalDataSource对应外部属性服务，imRelationEngine对应关联关系引擎服务，imAPI对应消息系统，imEOC对应企业运营中心。

* 同时，又根据信息的类型为做了分类，Warn分类的为警告，info分类的为输出，Error分类的为错误。

* 在出现问题查看系统日志时，应该根据日志的修改时间进行排序，通常情况下，按照修改时间查看最新的往往可以很快速的定位问题的原因。当我们查看时，如果日志信息过多，就应该将滚动条拖到最下方，从距离当前时间最近的信息开始排查。

## 日志排查问题建议

* 如果是在活动流转过程中出现的问题，一般情况下，会查看imProcessManagement，如果有流程后函数相关的信息，可能就是相关的流程后函数执行不成功，这时候需要逐步排查，检查流程后函数参数是否正确，参数的数量是否正确，配置的位置是否合理，如果一切正常，查看参数中是否包含了作业组属性名，包含有很大可能是对该作业组属性有所操作，这时候需要去排查作业组属性权限的配置，已经在网页端查看其在流程过后是否有值。
  * 比如`执行“ModifyActor("设备维护员执行","设备维护员执行人","Update");事件，出现错误，错误信息为：作业组属性【设备维护员执行人】的值为空`，此函数为跟作业组属性'设备维护员执行人'的值修改修改流程活动'设备维护员执行'的参与人，报错信息说明了作业组属性是没有值的，所以函数执行失败无法修改参与人。

* 如果在使用EOC时有错误发生，正常来说日志中也会有相应信息，可以逐步排查iis是否正常部署，正常运行，浏览器是否兼容，需要调用API的地方，则查看API日志，排查API是否正常部署，正常运行，SMC中消息地址是否填写正确。

* 在终端同步时需要的问题通常有以下场景和排查处理办法：

   **异常描述:** 同步启动即终止，耗时1秒内

   异常提示：同步异常终止，异常信息为：没有终结点对可能接受消息xxxx

   异常原因: 手持终端通讯中断

   处理办法: 检查手持终端的网络连接,确保其稳定连接，再次同步

   **异常描述:** 同步终止

   异常提示：同步异常终止，异常信息为：在接收对`http://服务器IP：XXXX/SyncService/的HTTP响应时出现错误`。

   异常原因: 终端无法连接至通知服务器或im通知服务停止

   处理办法:

   检查服务器IP配置是否为im通知服务器IP,并修正

   检查服务器imSMC上im通知服务并重新启动

   **异常描述:** 同步终止

   异常提示: 此终端没有被授权

   异常原因: 没有安装授权文件或该终端没有在imSMC注册、启用

   处理办法:

   查看imSMC是否安装授权文件

   使用imSMC创建终端节点并启用

   **异常描述:** 同步终止

   异常提示: 同步异常终止，异常信息为: 无效的URI，无法分析主机名

   异常原因: 未配置服务器IP或配置格式不正确

   处理办法: 检查服务器IP配置并修正

   **异常描述:** 同步终止

   异常提示: 当前用户已被删除，请先注销同步基础信息，再重新登录

   异常原因: 解决方案变更

   处理办法: 注销当前登录，回到登录界面同步基础信息后重新登录

   **异常描述:** 同步进行中终止

   异常提示: 同步异常终止，异常信息为: 服务端数据库连接错误

   异常原因: SQLServer或POSTGRESQL数据库服务停止

   处理办法: 打开任务管理器\服务，找到并启动SQL Server (MSSQLSERVER）或PostgreSQL服务，再进行同步

   **异常描述:** 同步进行中终止

   异常提示: 此SqlCeTransaction已完成；它不可再使用

   异常原因: PDA内存已满

   处理办法: 清除PDA上不必要文件或程序

* 如果在日志中，有记录到类似于`--- 内部异常堆栈跟踪的结尾 ---  在 RabbitMQ.Client.XXXX由于目标计算机积极拒绝`的信息，则极大可能是与RabbitMQ的通讯发生问题，需要在任务管理器中找到RabbitMQ，查看是否正在运行。如果时，再查看SMC中对于RabbitMQ的配置，是否有问题，服务器ip地址的填写以及RabbitMQ账号密码的填写，并确保其端口没有被其他程序占用，配置正确之后再重新尝试。

* 如果日志中有类似于`--- 内部异常堆栈跟踪的结尾 ---  在 MongoDB.Driver.XXXX`相关信息，在登录EOC时速度缓慢，或作业组归档时出现问题等，优先排查MongoDB服务是否正常运行，SMC中与MongoDB的连接配置是否正确，测试连接是否成功。

* 如果在日志信息中记录有`System.OutOfMemoryException:引发类型为“System.OutOfMemoryException”的异常`，是因为同时运行的资源过多，占用量过大导致内存不足溢出，这种情况需要优化进程或考虑增加内存。

* 同时，在SMC中，内置了系统环境诊断，当系统环境发生问题时，可以直接在SMC中点击此按钮，对整体的运行环境做一个诊断，然后根据里面报错的信息进行排查。

  <img alt=" " src={useBaseUrl('docimg/运维建议43012.png')} />

  * 其中包括了基本信息（服务器名，操作系统，ip相关信息以及应用版本）、授权信息、系统资源（服务器的一些资源信息，如内存、CPU、磁盘等）、关系型数据库（当前正在连接的数据库相关信息）、MongoDB（MongoDB相关信息及当前的连接情况）、RabbitMQ（RabbitMQ相关信息及当前的连接情况）、WebSocket（WebSocket相关信息及当前的连接情况）、企业运营中心（EOC相关信息及当前的连接情况）、RestfulAPI（API相关信息及当前的连接情况）、同步服务（同步服务相关信息及当前的连接情况）、邮件服务（邮件服务相关信息）、短信服务（短信服务相关信息）、终端推送（终端推送相关信息）、imgenius服务（imgenius应用的7大服务，数据服务、流程服务、作业服务、通知服务、搜索服务、关系引擎、外部属性的运行情况）等。

    <img alt=" " src={useBaseUrl('docimg/运维建议43013.png')} />

    <img alt=" " src={useBaseUrl('docimg/运维建议43014.png')} />

    <img alt=" " src={useBaseUrl('docimg/运维建议43015.png')} />

* 最后还有一些在日志信息中表明涉及到了后台代码或程序的报错，无法直接通过错误信息来进行分析和排查的，请联系我们。
